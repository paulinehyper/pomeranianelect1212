<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>메일 목록</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #fffbe7; }
    .emails-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .emails-table th, .emails-table td { border: 1px solid #e1c97a; padding: 8px; font-size: 0.95em; }
    .emails-table th { background: #ffe9a7; }
    .emails-table tr:nth-child(even) { background: #fff6d6; }
    .emails-table tr:hover { background: #ffe9a7; }
    .emails-header { font-size: 1.2em; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="modal-content">
    <div class="emails-header">저장된 메일 목록</div>
    <table class="emails-table" id="emailsTable">
      <thead>
        <tr>
          <th>수신일</th>
          <th>제목</th>
          <th>발신자</th>
          <th>To-Do</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS로 메일 목록 렌더링 -->
      </tbody>
    </table>
  </div>
  <script>
    function renderEmails(emails) {
      const tbody = document.getElementById('emailsTable').querySelector('tbody');
      tbody.innerHTML = '';
      emails.forEach(mail => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${mail.received_at}</td>
          <td class="subject-cell" style="cursor:pointer;color:#b48a00;text-decoration:underline;">${mail.subject}</td>
          <td>${mail.from_addr}</td>
          <td><input type="checkbox" ${mail.todo_flag ? 'checked' : ''} data-id="${mail.id}" /></td>
        `;
        tbody.appendChild(tr);
        // 본문 펼침용 row
        const bodyTr = document.createElement('tr');
        bodyTr.style.display = 'none';
        const bodyTd = document.createElement('td');
        bodyTd.colSpan = 4;
        bodyTd.style.background = '#fffbe7';
        bodyTd.style.color = '#333';
        bodyTd.style.fontSize = '0.97em';
        bodyTd.style.padding = '12px 16px';
        bodyTd.textContent = mail.body || '(본문 없음)';
        bodyTr.appendChild(bodyTd);
        tbody.appendChild(bodyTr);
        // 제목 클릭시 본문 토글
        tr.querySelector('.subject-cell').addEventListener('click', () => {
          // 새 창에 본문 표시 (항상 맨 앞에 오도록 focus)
          const win = window.open('', '_blank', 'width=600,height=400,alwaysRaised=yes,popup=yes');
          win.document.write(`
            <html><head><title>${mail.subject}</title>
            <style>body{font-family:sans-serif;background:#fffbe7;padding:24px;}h2{color:#b48a00;}pre{white-space:pre-wrap;word-break:break-all;}</style>
            </head><body>
            <h2>${mail.subject}</h2>
            <div><b>From:</b> ${mail.from_addr}</div>
            <div><b>Date:</b> ${mail.received_at}</div>
            <hr/>
            <pre>${mail.body ? mail.body.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '(본문 없음)'}</pre>
            </body></html>
          `);
          win.document.close();
          win.focus();
        });
      });
      // 체크박스 이벤트
      tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', async (e) => {
          const id = cb.getAttribute('data-id');
          const flag = cb.checked ? 1 : 0;
          await window.electronAPI.setEmailTodoFlag(id, flag);
          // 최신 목록 다시 렌더링
          const emails = await window.electronAPI.getEmails();
          renderEmails(emails);
        });
      });
    }
    window.electronAPI.getEmails().then(renderEmails);
    // 1분마다 메일 목록 새로고침
    setInterval(async () => {
      const emails = await window.electronAPI.getEmails();
      if (typeof renderEmails === 'function') renderEmails(emails);
    }, 60 * 1000);
  </script>
</body>
</html>
