<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Main ìœ„ì ¯</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif;
    }
    .widget-home {
      position: fixed;
      top: 40px;
      left: 40px;
      width: 500px;
      min-height: 540px;
      background: #f8fffd;
      border-radius: 18px;
      box-shadow: 0 4px 32px #00b49a22, 0 1.5px 0 #00b49a11;
      overflow: hidden;
      z-index: 10000;
      display: flex;
      flex-direction: column;
    }
    .widget-home-header {
      position: relative;
      height: 64px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      box-shadow: 0 2px 8px #00b49a11;
      font-size: 1.25em;
      font-weight: bold;
      color: #00b49a;
      -webkit-app-region: drag;
      user-select: none;
    }
    .widget-home-header * {
      -webkit-app-region: no-drag;
    }
    .widget-home-sidebar {
      position: absolute;
      top: 64px;
      left: 0;
      width: 54px;
      height: calc(100% - 64px);
      background: #f8fffd;
      box-shadow: 2px 0 8px #00b49a11;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding-top: 18px;
      z-index: 2;
    }
    .widget-home-main {
      margin-left: 54px;
      padding: 32px 18px 18px 18px;
      min-height: 400px;
      background: #f8fffd;
      flex: 1;
      z-index: 1;
    }
    .widget-home-sidebar button {
      background: transparent;
      border: none;
      cursor: pointer;
      margin-bottom: 8px;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .widget-home-sidebar svg {
      width: 22px;
      height: 22px;
    }
  </style>
</head>
<body>
  <div class="widget-home">
    <div class="widget-home-header">
      <span style="display:inline-flex;align-items:center;gap:8px;">
        <img src="assets/icon.png" alt="ì•± ì•„ì´ì½˜" style="width:28px;height:28px;vertical-align:middle;margin-right:4px;border-radius:7px;box-shadow:0 1px 4px #00b49a22;" />
        Main
      </span>
      <div>
        <button id="closeBtn" title="ë‹«ê¸°" style="background:transparent;border:none;font-size:1.5em;color:#00b49a;cursor:pointer;">Ã—</button>
      </div>
    </div>
    <div class="widget-home-sidebar">
      <button title="í™ˆ">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 11.5L12 4l9 7.5" stroke="#00b48a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <rect x="6.5" y="11.5" width="11" height="7" rx="2" stroke="#00b48a" stroke-width="2" fill="#e6fff7"/>
        </svg>
      </button>
      <button title="í‚¤ì›Œë“œ ê´€ë¦¬">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="7" width="12" height="6" rx="2" fill="#fff" stroke="#00b48a" stroke-width="1.5"/>
          <rect x="10.5" y="8.5" width="1.2" height="3.5" rx="0.6" fill="#7affe4"/>
        </svg>
      </button>
      <button title="ì´ë©”ì¼ ì—°ë™">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2.5" y="5" width="15" height="10" rx="2" stroke="#00b48a" stroke-width="1.5" fill=""/>
          <path d="M3.5 6l6.5 6 6.5-6" stroke="#00b48a" stroke-width="1.5" fill="none"/>
        </svg>
      </button>
      <button title="í™˜ê²½ì„¤ì •">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 6.5v-2M10 15.5v-2M13.5 10h2M4.5 10h2M13.03 13.03l1.42 1.42M5.55 5.55l1.42 1.42M13.03 6.97l1.42-1.42M5.55 14.45l1.42-1.42" stroke="#00b48a" stroke-width="1.2" stroke-linecap="round"/>
          <circle cx="10" cy="10" r="2.2" stroke="#00b48a" stroke-width="1.2" fill="#e6fff7"/>
        </svg>
      </button>
    </div>
    <div class="widget-home-main" id="widgetHomeMain">
      <h2 id="mainTitle" style="color:#00b49a;margin:0 0 18px 0;font-size:1.2em;">Main</h2>
      <!-- ìœ„ì ¯ ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    </div>
  </div>
  <script>
    // robust sidebar switching and event binding
    const sidebarBtns = document.querySelectorAll('.widget-home-sidebar button');
    const widgetMain = document.getElementById('widgetHomeMain');

    function renderMainContent(idx) {
      let contentHtml = "";
        if (idx === 0) {
          contentHtml = `
          <h2 id=\"mainTitle\" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;'>ğŸ  í™ˆ(Home) í™”ë©´</h2>
          <div style="width:100%;max-width:360px;margin:0 auto 12px auto;display:flex;gap:8px;">
            <input type="text" id="addTodoInput" placeholder="í• ì¼ ì…ë ¥" style="flex:1;padding:8px 12px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;" />
            <input type="date" id="addTodoDeadline" style="padding:8px 12px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;" />
            <button id="addTodoBtn" style="background:#00b49a;color:#fff;border:none;padding:8px 18px;border-radius:8px;font-weight:bold;cursor:pointer;transition:background 0.15s;">ì¶”ê°€</button>
          </div>
          <ul id=\"todoCardList\" class=\"schedule-list\" style=\"padding:0;list-style:none;max-width:360px;margin:0 auto;\"></ul>
          <style>
          .schedule-list li.todo-card {
            background:#fff;
            border-radius:10px;
            box-shadow:0 2px 8px #00b49a11;
            padding:16px 18px;
            margin-bottom:12px;
            font-size:1.08em;
            color:#00b49a;
            font-weight:bold;
            transition:box-shadow 0.15s, text-decoration 0.15s, color 0.15s;
            cursor:pointer;
            position:relative;
          }
          .schedule-list li.todo-card:hover {
            box-shadow:0 4px 16px #00b49a22;
          }
          .schedule-list li.todo-card.done {
            text-decoration: line-through;
            color: #ffffff !important;
            text-decoration-color: #686868 !important;
            font-color: #ff6868 !important;
           
          .remove-todo-btn:hover {
            background:#ffeaea;
            border:1.5px solid #ffbaba;
          }
          </style>
          `;
      } else if (idx === 1) {
        contentHtml = `
        <h2 id=\"mainTitle\" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;'>í‚¤ì›Œë“œ ê´€ë¦¬</h2>
        <div class=\"keyword-input-row\" style=\"width:100%;max-width:360px;display:flex;gap:8px;margin-bottom:12px;\">
          <input type=\"text\" id=\"keywordInput\" class=\"keyword-input\" placeholder=\"í‚¤ì›Œë“œ ì…ë ¥\" style=\"flex:1;padding:6px 8px;border-radius:6px;border:1px solid #7be2c5;\" />
          <button id=\"addKeywordBtn\" class=\"keyword-add-btn\" style=\"background:#e7fffe;color:#00b48a;border:none;padding:6px 18px;border-radius:6px;font-weight:bold;cursor:pointer;transition:background 0.15s;\">ì¶”ê°€</button>
        </div>
        <div id=\"keywordList\" style=\"width:100%;max-width:360px;min-height:32px;margin-bottom:8px;\"></div>
        <div style=\"color:#888;font-size:0.98em;\">ì—¬ê¸°ì„œ í‚¤ì›Œë“œë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        `;
      } else if (idx === 2) {
        contentHtml = `<h2 id="mainTitle" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;display:flex;align-items:center;gap:10px;'>ì´ë©”ì¼ ëª©ë¡ <span id='emailCount' style='font-size:0.9em;color:#0093b4;'></span><button id='reloadEmailBtn' style='margin-left:8px;padding:4px 12px;font-size:0.95em;background:#eaf6ff;border:1px solid #b3d8f8;border-radius:6px;cursor:pointer;'>ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button><button id='excludeAllEmailBtn' style='margin-left:8px;padding:4px 12px;font-size:0.95em;background:#e57373;color:#fff;border:none;border-radius:6px;cursor:pointer;'>ì „ì²´ ì œì™¸</button></h2><div style='margin-bottom:10px;'><label for='emailSortSelect' style='font-size:0.98em;color:#0093b4;font-weight:bold;margin-right:8px;'>ì •ë ¬:</label><select id='emailSortSelect' style='padding:4px 10px;border-radius:6px;border:1px solid #7be2c5;font-size:1em;'><option value='date-desc'>ìˆ˜ì‹ ë‚ ì§œ ìµœì‹ ìˆœ</option><option value='date-asc'>ìˆ˜ì‹ ë‚ ì§œ ì˜¤ë˜ëœìˆœ</option><option value='from'>ìˆ˜ì‹ ììˆœ</option><option value='todo'>í• ì¼ ìš°ì„ </option></select></div><div id='emailListLoading' style='color:#888;margin-bottom:12px;'>ë©”ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div><ul id='emailList' style='padding:0;list-style:none;max-height:420px;overflow-y:auto;border:1px solid #e0e0e0;background:#f8fffd;'></ul>`;
      } else if (idx === 3) {
        contentHtml = `
        <h2 id="mainTitle" style='color:#00b49a;margin:0 0 18px 0;font-size:1.2em;'>í™˜ê²½ì„¤ì •</h2>
        <form id='mailSettingsForm' style='display:flex;flex-direction:column;gap:18px;align-items:stretch;margin-top:18px;max-width:340px;margin-left:auto;margin-right:auto;'>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ë°©ì‹/ë³´ì•ˆ</label>
            <select id='protocolSecurity' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;'>
              <option value='imap'>IMAP (ì¼ë°˜, 143)</option>
              <option value='imap-secure'>IMAP (SSL, 993)</option>
              <option value='pop3-secure'>POP3 (ë³´ì•ˆ, 995)</option>
              <option value='pop3'>POP3 (ì¼ë°˜, 110)</option>
              <option value='custom'>ì‚¬ìš©ì ì…ë ¥</option>
            </select>
            <div id='customPortDiv' style='display:none;flex-direction:column;gap:8px;margin-top:8px;'>
              <label for='customPort' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>í¬íŠ¸</label>
              <input id='customPort' type='number' placeholder='í¬íŠ¸ë²ˆí˜¸ ì…ë ¥' min='1' max='65535' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
            </div>
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label for='host' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ì„œë²„</label>
            <input id='host' type='text' placeholder='mail.example.com' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label for='mailId' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ì•„ì´ë””</label>
            <input id='mailId' type='text' placeholder='user@email.com' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label for='mailPw' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ë¹„ë°€ë²ˆí˜¸</label>
            <input id='mailPw' type='password' placeholder='ë¹„ë°€ë²ˆí˜¸' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
          </div>
          <div style='display:flex;flex-direction:column;gap:8px;'>
            <label for='mailSince' style='font-weight:bold;color:#0093b4;margin-bottom:2px;'>ìˆ˜ì‹ ë°›ì€ë‚ ì§œ</label>
            <input id='mailSince' type='date' placeholder='yyyy-mm-dd' style='padding:8px 16px;border-radius:8px;border:1.5px solid #7be2c5;font-size:1em;outline:none;background:#f8fffd;' />
          </div>
          <button type='submit' style='margin-top:10px;background:#00b49a;color:#fff;border:none;padding:10px 36px;border-radius:8px;font-weight:bold;font-size:1.1em;cursor:pointer;box-shadow:0 2px 8px #00b49a22;'>ì €ì¥</button>
        </form>`;
      }
      widgetMain.innerHTML = contentHtml;
        // í™ˆí™”ë©´ í• ì¼ ì¹´ë“œ(ë©”ì¼ ì œëª©ë§Œ) ë Œë”ë§
        if (idx === 0 && window.electronAPI && window.electronAPI.getTodos) {
          // í• ì¼ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
          setTimeout(() => {
            const addBtn = document.getElementById('addTodoBtn');
            const addInput = document.getElementById('addTodoInput');
            const addDeadline = document.getElementById('addTodoDeadline');
            if (addBtn && addInput && addDeadline && window.electronAPI && window.electronAPI.insertTodo) {
              const addTodo = async () => {
                const task = addInput.value.trim();
                const deadline = addDeadline.value ? addDeadline.value : '';
                if (!task) return;
                await window.electronAPI.insertTodo({ task, deadline });
                addInput.value = '';
                addDeadline.value = '';
                renderMainContent(0);
              };
              addBtn.onclick = addTodo;
              addInput.onkeydown = (e) => {
                if (e.key === 'Enter') addTodo();
              };
              addDeadline.onkeydown = (e) => {
                if (e.key === 'Enter') addTodo();
              };
            }
          }, 100);
          window.electronAPI.getTodos().then(res => {
            const cardList = document.getElementById('todoCardList');
            if (!cardList) return;
            if (res && res.length > 0) {
              cardList.innerHTML = res.map((todo, i) => {
                let deadlineStr = '';
                let ddayStr = '';
                if (todo.deadline && todo.deadline !== 'ì—†ìŒ') {
                  deadlineStr = todo.deadline;
                  // D-day ê³„ì‚°
                  const now = new Date();
                  const deadlineDate = new Date(todo.deadline);
                  if (!isNaN(deadlineDate)) {
                    const diff = Math.ceil((deadlineDate - now) / (1000*60*60*24));
                    ddayStr = diff >= 0 ? `D-${diff}` : `D+${Math.abs(diff)}`;
                  }
                }
                return `
                  <li class='todo-card' style='position:relative;'>
                    <span style="color:#03af7c;font-weight:normal;margin-right:8px;">${deadlineStr}${ddayStr ? ' (' + ddayStr + ')' : ''}</span>
                    <span>${todo.task || '(ì œëª© ì—†ìŒ)'}</span>
                    <button class="remove-todo-btn" data-id="${todo.id}" title="ì œì™¸" style="position:absolute;top:10px;right:12px;background:#fff;border:1.5px solid #e0e0e0;color:#ff5a5a;border-radius:50%;width:26px;height:26px;font-size:1.1em;line-height:1;cursor:pointer;box-shadow:0 1px 4px #00b49a11;display:flex;align-items:center;justify-content:center;transition:background 0.15s,border 0.15s;">-</button>
                  </li>
                `;
              }).join('');
              // í• ì¼ ì¹´ë“œ í´ë¦­ ì‹œ ì·¨ì†Œì„  í† ê¸€
              cardList.querySelectorAll('.todo-card').forEach(card => {
                card.addEventListener('click', function(e) {
                  // ì œì™¸ ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì·¨ì†Œì„  í† ê¸€ ë°©ì§€
                  if (e.target.classList.contains('remove-todo-btn')) return;
                  this.classList.toggle('done');
                });
              });
              // ì œì™¸ ë²„íŠ¼ ì´ë²¤íŠ¸
              cardList.querySelectorAll('.remove-todo-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                  e.stopPropagation();
                  const id = this.dataset.id;
                  if (window.electronAPI && window.electronAPI.excludeTodo) {
                    window.electronAPI.excludeTodo(Number(id));
                  }
                  const li = this.closest('li');
                  if (li) li.remove();
                  // ì´ë©”ì¼ ëª©ë¡ë„ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
                  renderMainContent(2);
                });
              });
            } else {
              cardList.innerHTML = `<li style='color:#bbb;text-align:center;padding:24px 0;'>ë“±ë¡ëœ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
            }
          });
        }
      if (idx === 2) {
                                        // ì „ì²´ ì œì™¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
                                        setTimeout(() => {
                                          const excludeAllBtn = document.getElementById('excludeAllEmailBtn');
                                          if (excludeAllBtn) {
                                            excludeAllBtn.onclick = async function() {
                                              if (window.electronAPI && window.electronAPI.getEmails && window.electronAPI.setEmailTodoFlag) {
                                                const emails = await window.electronAPI.getEmails();
                                                const promises = emails.map(mail => window.electronAPI.setEmailTodoFlag(mail.id, 0));
                                                await Promise.all(promises);
                                                renderMainContent(2);
                                              }
                                            };
                                          }
                                        }, 100);
                        // ì´ë©”ì¼ ëª©ë¡ ìë™ ê°±ì‹  íƒ€ì´ë¨¸ ê´€ë¦¬
                        if (window.__emailListInterval) {
                          clearInterval(window.__emailListInterval);
                        }
                        window.__emailListInterval = setInterval(async () => {
                          if (window.electronAPI && window.electronAPI.getEmails) {
                            const emails = await window.electronAPI.getEmails();
                            const emailList = document.getElementById('emailList');
                            const emailCount = document.getElementById('emailCount');
                            if (emailCount) emailCount.textContent = `(${emails.length})`;
                            if (emailList) {
                              if (emails && emails.length > 0) {
                                emailList.innerHTML = emails.map((mail, idx) => `
                                  <li class='email-item' data-idx='${idx}' style='margin-bottom:14px;padding:12px 24px 12px 24px;min-width:380px;max-width:99%;background:#fff;border-radius:8px;box-shadow:0 2px 8px #00b49a11;position:relative;display:block;'>
                                    ${mail.todo_flag === 1 ? `<div style='position:absolute;top:8px;left:12px;background:#e7fffe;color:#00b49a;font-size:0.92em;padding:2px 10px;border-radius:6px;font-weight:bold;box-shadow:0 1px 4px #00b49a11;z-index:2;'>í• ì¼</div>` : ''}
                                    <div style='padding-left:60px;margin-top:22px;'>
                                      <div style="color:#888;font-size:0.97em;">${(mail.received_at ? (new Date(mail.received_at).toISOString().slice(0,10)) : '')}</div>
                                      <div style="color:#0093b4;font-size:0.99em;">${mail.from_addr || ''}</div>
                                      <div style="font-weight:bold;color:#222;margin:2px 0 0 0;">${mail.subject}</div>
                                    </div>

                                    <div style='color:#888;font-size:0.92em;margin-top:4px;'>${mail.received_at} / ${mail.from_addr}</div>
                                    ${mail.todo_flag === 1
                                      ? `<button class='remove-todo-btn' data-idx='${idx}' style='position:absolute;top:12px;right:16px;background:#ffeaea;color:#ff5a5a;border:1.5px solid #ffbaba;padding:4px 12px;border-radius:6px;font-size:0.95em;cursor:pointer;'>í• ì¼ ì œì™¸</button>`
                                      : `<button class='add-todo-btn' data-idx='${idx}' style='position:absolute;top:12px;right:16px;background:#00b49a;color:#fff;border:none;padding:4px 12px;border-radius:6px;font-size:0.95em;cursor:pointer;'>í• ì¼ë¡œ ì¶”ê°€</button>`}
                                  </li>
                                `).join('');
                              } else {
                                emailList.innerHTML = '<li style="color:#888;padding:18px;text-align:center;">ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                              }
                            }
                          }
                        }, 60 * 1000);
                // ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
                setTimeout(() => {
                  const reloadBtn = document.getElementById('reloadEmailBtn');
                  if (reloadBtn) {
                    reloadBtn.onclick = async function() {
                      reloadBtn.disabled = true;
                      reloadBtn.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                      try {
                        // í™˜ê²½ì„¤ì • ì •ë³´ë¡œ ë©”ì¼ ì—°ë™ ë° ë™ê¸°í™”
                        if (window.electronAPI && window.electronAPI.startMailSync) {
                          await window.electronAPI.startMailSync();
                        }
                        // ë™ê¸°í™” í›„ ìµœì‹  ë©”ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                        if (window.electronAPI && window.electronAPI.getEmails) {
                          const emails = await window.electronAPI.getEmails();
                          const emailList = document.getElementById('emailList');
                          const loading = document.getElementById('emailListLoading');
                          const emailCount = document.getElementById('emailCount');
                          if (loading) loading.style.display = 'none';
                          if (emailCount) emailCount.textContent = `(${emails.length})`;
                          if (emailList) {
                            if (emails && emails.length > 0) {
                              emailList.innerHTML = emails.map((mail, idx) => `
                                  <li class='email-item' data-idx='${idx}' style='margin-bottom:14px;padding:12px 24px 12px 24px;min-width:380px;max-width:99%;background:#fff;border-radius:8px;box-shadow:0 2px 8px #00b49a11;position:relative;display:block;'>
                                  ${mail.todo_flag === 1 ? `<div style='position:absolute;top:8px;left:12px;background:#e7fffe;color:#00b49a;font-size:0.92em;padding:2px 10px;border-radius:6px;font-weight:bold;box-shadow:0 1px 4px #00b49a11;z-index:2;'>í• ì¼</div>` : ''}
                                  <div style='padding-left:60px;margin-top:22px;'>
                                    <div style="color:#888;font-size:0.97em;">${(mail.received_at ? (new Date(mail.received_at).toISOString().slice(0,10)) : '')}</div>
                                    <div style="color:#0093b4;font-size:0.99em;">${mail.from_addr || ''}</div>
                                    <div style="font-weight:bold;color:#222;margin:2px 0 0 0;">${mail.subject}</div>
                                  </div>

                                  <div style='color:#888;font-size:0.92em;margin-top:4px;'>${mail.received_at} / ${mail.from_addr}</div>
                                  ${mail.todo_flag === 1
                                    ? `<button class='remove-todo-btn' data-idx='${idx}' style='position:absolute;top:12px;right:16px;background:#ffeaea;color:#ff5a5a;border:1.5px solid #ffbaba;padding:4px 12px;border-radius:6px;font-size:0.95em;cursor:pointer;'>í• ì¼ ì œì™¸</button>`
                                    : `<button class='add-todo-btn' data-idx='${idx}' style='position:absolute;top:12px;right:16px;background:#00b49a;color:#fff;border:none;padding:4px 12px;border-radius:6px;font-size:0.95em;cursor:pointer;'>í• ì¼ë¡œ ì¶”ê°€</button>`}
                                </li>
                              `).join('');
                              // ...ê¸°ì¡´ ìƒì„¸ íŒì—… ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° ì½”ë“œ...
                            } else {
                              emailList.innerHTML = '<li style="color:#888;padding:18px;text-align:center;">ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                            }
                          }
                        }
                      } finally {
                        reloadBtn.disabled = false;
                        reloadBtn.textContent = 'ë©”ì¼ ë¶ˆëŸ¬ì˜¤ê¸°';
                      }
                    };
                  }
                }, 100);
        // ì´ë©”ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        if (window.electronAPI && window.electronAPI.getEmails) {
          window.electronAPI.getEmails().then(emails => {
            let currentSort = 'date-desc';
            const emailList = document.getElementById('emailList');
            const loading = document.getElementById('emailListLoading');
            const emailCount = document.getElementById('emailCount');
            const sortSelect = document.getElementById('emailSortSelect');
            function renderEmailList(sortedEmails) {
              if (loading) loading.style.display = 'none';
              if (emailCount) emailCount.textContent = `(${sortedEmails.length})`;
              if (emailList) {
                if (sortedEmails && sortedEmails.length > 0) {
                  emailList.innerHTML = sortedEmails.map((mail, idx) => `
                    <li class='email-item' data-idx='${idx}' style='margin-bottom:14px;padding:12px 24px 12px 24px;min-width:380px;max-width:99%;background:#fff;border-radius:8px;box-shadow:0 2px 8px #00b49a11;position:relative;display:block;'>
                      ${mail.todo_flag === 1 ? `<div style='position:absolute;top:8px;left:12px;background:#e7fffe;color:#00b49a;font-size:0.92em;padding:2px 10px;border-radius:6px;font-weight:bold;box-shadow:0 1px 4px #00b49a11;z-index:2;'>í• ì¼</div>` : ''}
                      <div style='padding-left:60px;margin-top:22px;'>
                        <div style="color:#888;font-size:0.97em;">${(mail.received_at ? (new Date(mail.received_at).toISOString().slice(0,10)) : '')}</div>
                        <div style="color:#0093b4;font-size:0.99em;">${mail.from_addr || ''}</div>
                        <div style="font-weight:bold;color:#222;margin:2px 0 0 0;">${mail.subject}</div>
                      </div>

                      <div style='color:#888;font-size:0.92em;margin-top:4px;'>${mail.received_at} / ${mail.from_addr}</div>
                      ${mail.todo_flag === 1
                        ? `<button class='remove-todo-btn' data-idx='${idx}' style='position:absolute;top:12px;right:16px;background:#ffeaea;color:#ff5a5a;border:1.5px solid #ffbaba;padding:4px 12px;border-radius:6px;font-size:0.95em;cursor:pointer;'>í• ì¼ ì œì™¸</button>`
                        : `<button class='add-todo-btn' data-idx='${idx}' style='position:absolute;top:12px;right:16px;background:#00b49a;color:#fff;border:none;padding:4px 12px;border-radius:6px;font-size:0.95em;cursor:pointer;'>í• ì¼ë¡œ ì¶”ê°€</button>`}
                    </li>
                  `).join('');
                  // ìƒì„¸ íŒì—… ì´ë²¤íŠ¸ ì—°ê²°
                  document.querySelectorAll('.email-item').forEach(item => {
                    const addBtn = item.querySelector('.add-todo-btn');
                    const removeBtn = item.querySelector('.remove-todo-btn');
                    if (addBtn) {
                      addBtn.onclick = async function(e) {
                        e.stopPropagation();
                        const mail = sortedEmails[parseInt(this.dataset.idx)];
                        if (window.electronAPI && window.electronAPI.addTodoFromMail) {
                          await window.electronAPI.addTodoFromMail(mail.id);
                          // í• ì¼ ëª©ë¡ ì¦‰ì‹œ ê°±ì‹ 
                          if (window.electronAPI.getTodos) {
                            const todos = await window.electronAPI.getTodos();
                            const cardList = document.getElementById('todoCardList');
                            if (cardList && todos && todos.length > 0) {
                              cardList.innerHTML = todos.map((todo, i) => {
                                let deadlineStr = '';
                                let ddayStr = '';
                                if (todo.deadline && todo.deadline !== 'ì—†ìŒ') {
                                  deadlineStr = todo.deadline;
                                  const now = new Date();
                                  const deadlineDate = new Date(todo.deadline);
                                  if (!isNaN(deadlineDate)) {
                                    const diff = Math.ceil((deadlineDate - now) / (1000*60*60*24));
                                    ddayStr = diff >= 0 ? `D-${diff}` : `D+${Math.abs(diff)}`;
                                  }
                                }
                                return `
                                  <li class='todo-card' style='position:relative;'>
                                    <span style="color:#03af7c;font-weight:normal;margin-right:8px;">${deadlineStr}${ddayStr ? ' (' + ddayStr + ')' : ''}</span>
                                    <span>${todo.task || '(ì œëª© ì—†ìŒ)'}</span>
                                    <button class="remove-todo-btn" data-id="${todo.id}" title="ì œì™¸" style="position:absolute;top:10px;right:12px;background:#fff;border:1.5px solid #e0e0e0;color:#ff5a5a;border-radius:50%;width:26px;height:26px;font-size:1.1em;line-height:1;cursor:pointer;box-shadow:0 1px 4px #00b49a11;display:flex;align-items:center;justify-content:center;transition:background 0.15s,border 0.15s;">-</button>
                                  </li>
                                `;
                              }).join('');
                            } else if (cardList) {
                              cardList.innerHTML = `<li style='color:#bbb;text-align:center;padding:24px 0;'>ë“±ë¡ëœ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
                            }
                          }
                        }
                      };
                    }
                    if (removeBtn) {
                      removeBtn.onclick = function(e) {
                        e.stopPropagation();
                        const mail = sortedEmails[parseInt(this.dataset.idx)];
                        if (window.electronAPI && window.electronAPI.excludeTodo) {
                          window.electronAPI.excludeTodo(mail.id).then(() => {
                            // emails í…Œì´ë¸” todo_flag=0, ê·¸ë¦¬ê³  unique_hashë¡œ todos í…Œì´ë¸”ë„ todo_flag=0
                            if (window.electronAPI && window.electronAPI.setEmailTodoFlag) {
                              window.electronAPI.setEmailTodoFlag(mail.id, 0);
                            }
                            renderMainContent(2);
                            renderMainContent(0);
                          });
                        }
                      };
                    }
                    item.onclick = function(e) {
                      if (e.target.classList.contains('add-todo-btn') || e.target.classList.contains('remove-todo-btn')) return;
                      const mail = sortedEmails[parseInt(this.dataset.idx)];
                      const params = new URLSearchParams({
                        subject: mail.subject,
                        received_at: mail.received_at,
                        from_addr: mail.from_addr,
                        body: mail.body || ''
                      });
                      if (window.electronAPI && window.electronAPI.openMailDetail) {
                        window.electronAPI.openMailDetail(params.toString());
                      } else {
                        window.open('mail-detail.html?' + params.toString(), '_blank', 'width=700,height=600');
                      }
                    };
                  });
                } else {
                  emailList.innerHTML = `<li style='color:#888;padding:12px;'>ë¶ˆëŸ¬ì˜¨ ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
                }
              }
            }
            function sortEmails(emails, sortKey) {
              if (sortKey === 'date-desc') {
                return [...emails].sort((a, b) => new Date(b.received_at) - new Date(a.received_at));
              } else if (sortKey === 'date-asc') {
                return [...emails].sort((a, b) => new Date(a.received_at) - new Date(b.received_at));
              } else if (sortKey === 'from') {
                return [...emails].sort((a, b) => (a.from_addr || '').localeCompare(b.from_addr || ''));
              } else if (sortKey === 'todo') {
                return [...emails].sort((a, b) => (b.todo_flag || 0) - (a.todo_flag || 0));
              }
              return emails;
            }
            // ìµœì´ˆ ë Œë”ë§
            renderEmailList(sortEmails(emails, currentSort));
            // ì •ë ¬ ë³€ê²½ ì´ë²¤íŠ¸
            if (sortSelect) {
              sortSelect.onchange = function() {
                currentSort = sortSelect.value;
                renderEmailList(sortEmails(emails, currentSort));
              };
            }
          });
        }
      }
      if (idx === 3) {
                // ì €ì¥ëœ ë©”ì¼ ì—°ë™ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ inputì— ìë™ ì±„ì›€
                if (window.electronAPI && window.electronAPI.getMailSettings) {
                  window.electronAPI.getMailSettings().then(settings => {
                    console.log('getMailSettings result:', settings);
                    if (settings) {
                      if (settings.host) document.getElementById('host').value = settings.host;
                      if (settings.mailId) document.getElementById('mailId').value = settings.mailId;
                      if (settings.mailPw) document.getElementById('mailPw').value = settings.mailPw;
                      if (settings.protocol) document.getElementById('protocolSecurity').value = settings.protocol;
                      if (settings.mailSince) document.getElementById('mailSince').value = settings.mailSince;
                      // custom port ì²˜ë¦¬
                      if (settings.port && settings.protocol === 'custom') {
                        document.getElementById('customPort').value = settings.port;
                        document.getElementById('customPortDiv').style.display = 'flex';
                      }
                    }
                  });
                }
        const protoSecSel = document.getElementById('protocolSecurity');
        const customPortDiv = document.getElementById('customPortDiv');
        const mailSettingsForm = document.getElementById('mailSettingsForm');
        protoSecSel.addEventListener('change', function() {
          customPortDiv.style.display = (this.value === 'custom') ? 'flex' : 'none';
        });
        mailSettingsForm.onsubmit = async (e) => {
          e.preventDefault();
          const protocol = document.getElementById('protocolSecurity').value;
          let port = (protocol === 'pop3-secure') ? 995 : document.getElementById('customPort').value;
          const settings = {
            protocol,
            port,
            mailId: document.getElementById('mailId').value,
            mailPw: document.getElementById('mailPw').value,
            host: document.getElementById('host').value,
            mailSince: document.getElementById('mailSince').value
          };
          if (window.electronAPI && window.electronAPI.saveMailSettings) {
            await window.electronAPI.saveMailSettings(settings);
            alert('ë©”ì¼ ì—°ë™ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            alert('Electron í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤.');
            console.log('Saved data:', settings);
          }
        };
      }
    }

    // ìƒì„¸ ë©”ì¼ íŒì—… í•¨ìˆ˜
    function showEmailDetailPopup(mail) {
      // ê¸°ì¡´ íŒì—… ì œê±°
      const oldPopup = document.getElementById('emailDetailPopup');
      if (oldPopup) oldPopup.remove();
      const popup = document.createElement('div');
      popup.id = 'emailDetailPopup';
      popup.style.position = 'fixed';
      popup.style.top = '0';
      popup.style.left = '0';
      popup.style.width = '100vw';
      popup.style.height = '100vh';
      popup.style.background = 'rgba(0,0,0,0.18)';
      popup.style.display = 'flex';
      popup.style.alignItems = 'center';
      popup.style.justifyContent = 'center';
      popup.style.zIndex = '9999';
      popup.innerHTML = `
        <div style="background:#fff;padding:32px 36px;border-radius:14px;min-width:320px;max-width:90vw;max-height:80vh;box-shadow:0 4px 24px #00b49a22;display:flex;flex-direction:column;align-items:flex-start;gap:18px;overflow-y:auto;">
          <div style='font-size:1.15em;font-weight:bold;color:#0093b4;margin-bottom:4px;'>${mail.subject}</div>
          <div style='color:#888;font-size:0.95em;margin-bottom:8px;'>${mail.received_at} / ${mail.from_addr}</div>
          <div style='color:#444;line-height:1.7;white-space:pre-wrap;font-size:1.05em;'>${mail.body ? mail.body : '<i>ë³¸ë¬¸ ì—†ìŒ</i>'}</div>
          <button id='closeEmailDetailPopup' style='margin-top:18px;background:#00b49a;color:#fff;border:none;padding:8px 24px;border-radius:8px;font-size:1em;cursor:pointer;align-self:center;'>ë‹«ê¸°</button>
        </div>
      `;
      document.body.appendChild(popup);
      document.getElementById('closeEmailDetailPopup').onclick = () => popup.remove();
      popup.onclick = (e) => { if (e.target === popup) popup.remove(); };
    }

    // ì´ë²¤íŠ¸ ì—°ê²° ë° ì´ˆê¸°í™”
    sidebarBtns.forEach((btn, idx) => {
      btn.onclick = () => {
        renderMainContent(idx);
      };
    });

    // ë‹«ê¸° ë²„íŠ¼
    document.getElementById('closeBtn').onclick = () => {
      if (window.electronAPI && window.electronAPI.close) {
        window.electronAPI.close();
      } else {
        window.close();
      }
    };

    // ì²« í™”ë©´ ì´ˆê¸°í™”
    renderMainContent(0);

    // ë™ì ìœ¼ë¡œ ì‚½ì…ëœ í‚¤ì›Œë“œ ê´€ë¦¬ ì…ë ¥ë€ ì´ë²¤íŠ¸ ì—°ê²°
    async function loadKeywordsToList() {
      if (!window.electronAPI.getKeywords) return;
      const res = await window.electronAPI.getKeywords();
      const list = document.getElementById('keywordList');
      if (!list) return;
      list.innerHTML = '';
      if(res.success && res.keywords.length > 0) {
        res.keywords.forEach(kw => {
          const div = document.createElement('div');
          div.className = 'keyword-item';
          div.textContent = kw;
          list.appendChild(div);
        });
      } else {
        list.innerHTML = '<div style="color:#bbb;">(ë“±ë¡ëœ í‚¤ì›Œë“œ ì—†ìŒ)</div>';
      }
    }
    function bindKeywordAddEvent() {
      const addBtn = document.getElementById('addKeywordBtn');
      const input = document.getElementById('keywordInput');
      if (addBtn && input) {
        const addKeyword = async () => {
          const kw = input.value.trim();
          if(!kw) return;
          await window.electronAPI.insertKeyword(kw);
          input.value = '';
          await loadKeywordsToList();
          setTimeout(() => {
            input.blur();
            input.focus();
          }, 100);
        };
        addBtn.onclick = addKeyword;
        input.onkeydown = (e) => {
          if (e.key === 'Enter') addKeyword();
        };
      }
    }
    // í™”ë©´ ì „í™˜ ì‹œë§ˆë‹¤ ì´ë²¤íŠ¸ ì—°ê²°
    function afterContentChange(idx) {
      if (idx === 1) {
        bindKeywordAddEvent();
        loadKeywordsToList();
      }
      if (idx === 3) {
        // í™˜ê²½ì„¤ì • ì§„ì… ì‹œ getMailSettingsë¡œ input ìë™ ì±„ì›€
        if (window.electronAPI && window.electronAPI.getMailSettings) {
          window.electronAPI.getMailSettings().then(settings => {
            console.log('getMailSettings (afterContentChange):', settings);
            if (settings) {
              if (settings.host) document.getElementById('host').value = settings.host;
              if (settings.mailId) document.getElementById('mailId').value = settings.mailId;
              if (settings.mailPw) document.getElementById('mailPw').value = settings.mailPw;
              if (settings.protocol) document.getElementById('protocolSecurity').value = settings.protocol;
              if (settings.port && settings.protocol === 'custom') {
                document.getElementById('customPort').value = settings.port;
                document.getElementById('customPortDiv').style.display = 'flex';
              }
            }
          });
        }
      }
    }
    // sidebar ë²„íŠ¼ í´ë¦­ ì‹œ í™”ë©´ ì „í™˜ ë° ì´ë²¤íŠ¸ ì—°ê²°
    // ì´ë©”ì¼ ëª©ë¡ í™”ë©´ì„ ë²—ì–´ë‚˜ë©´ ìë™ ê°±ì‹  íƒ€ì´ë¨¸ í•´ì œ
    function clearEmailListInterval() {
      if (window.__emailListInterval) {
        clearInterval(window.__emailListInterval);
        window.__emailListInterval = null;
      }
    }
    sidebarBtns.forEach((btn, idx) => {
      btn.onclick = () => {
        renderMainContent(idx);
        afterContentChange(idx);
        if (idx !== 2) clearEmailListInterval();
      };
    });
    // ì²« í™”ë©´ ì§„ì… ì‹œ ì´ë²¤íŠ¸ ì—°ê²°
    afterContentChange(0);
  </script>
</body>
</html>
